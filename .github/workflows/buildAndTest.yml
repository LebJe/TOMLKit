name: "Build and Test"

on: ["push", "pull_request"]

jobs:
    TestOnMacOS-11_0-x86_64:
        runs-on: "macos-11"
        steps:
            - uses: "actions/checkout@v2"
            - name: "Run tests"
              run: "swift test"
    # TestOnUbuntu-20_04-ARM:
    #   runs-on: ubuntu-latest
    #   steps:
    #     - uses: actions/checkout@v2
    #     - uses: uraimo/run-on-arch-action@v2.0.7
    #       with:
    #         arch: aarch64
    #         distro: ubuntu20.04
    #         githubToken: ${{ secrets.GITHUB_TOKEN }}
    #         run: |
    #           export DEBIAN_FRONTEND=noninteractive
    #           apt update -q
    #           apt install -yq curl sudo
    #           curl -s https://packagecloud.io/install/repositories/swift-arm/release/script.deb.sh | sudo bash
    #           apt install -yq swiftlang
    #           apt update -yq
    #           swift test
    TestOnUbuntu-20_04-x86_64:
        runs-on: "ubuntu-latest"
        steps:
            - uses: "actions/checkout@v2"
            - name: "Run tests"
              run: "swift test"
    TestOnWindows10-x86_64:
        runs-on: "windows-latest"
        # env:
        #     SDKROOT: 'C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk'
        steps:
            - uses: "actions/checkout@v2"
            - uses: "seanmiddleditch/gha-setup-vsdevenv@master"
            - uses: "compnerd/gha-setup-swift@main"
              with:
                  branch: "swift-5.5-release"
                  tag: "5.5-RELEASE"
            - name: "Check Clang"
              run: |
                  clang++ --version
                  clang --version
            - name: "Test"
              run: "swift test -Xcc -D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH -Xcxx -D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH"

            # - name: "Install swift-5.6-RELEASE"
            #   run: |
            #       Install-Binary -Url "https://download.swift.org/swift-5.5.3-release/windows10/swift-5.5.3-RELEASE/swift-5.5.3-RELEASE-windows10.exe" -Name "installer.exe" -ArgumentList ("-q")
            # - name: "Set Environment Variables"
            #   run: |
            #       echo "SDKROOT=C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            #       echo "DEVELOPER_DIR=C:\Library\Developer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            # - name: "Adjust Paths"
            #   run: echo "C:\Library\Developer\Toolchains\unknown-Asserts-development.xctoolchain\usr\bin;C:\Library\Swift-development\bin;C:\Library\icu-67\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            # - name: "Install Supporting Files"
            #   shell: "cmd"
            #   run: |
            #       copy "%SDKROOT%\usr\share\ucrt.modulemap" "%UniversalCRTSdkDir%\Include\%UCRTVersion%\ucrt\module.modulemap"
            #       copy "%SDKROOT%\usr\share\visualc.modulemap" "%VCToolsInstallDir%\include\module.modulemap"
            #       copy "%SDKROOT%\usr\share\visualc.apinotes" "%VCToolsInstallDir%\include\visualc.apinotes"
            #       copy "%SDKROOT%\usr\share\winsdk.modulemap" "%UniversalCRTSdkDir%\Include\%UCRTVersion%\um\module.modulemap"
            # - name: "Test"
            #   env:
            #       # From https://github.com/tsolomko/SWCompression/blob/74ae7c2edc8389207ea58dcca8a86eaa91675584/azure-pipelines.yml#L137
            #       SWIFTFLAGS: "--sdk ${{ env.SDKROOT }} -Xswiftc -sdk -Xswiftc ${{ env.SDKROOT }} -Xswiftc -resource-dir -Xswiftc ${{ env.SDKROOT }}/usr/lib/swift -Xswiftc -I -Xswiftc ${{ env.SDKROOT }}/usr/lib/swift -Xswiftc -L -Xswiftc ${{ env.SDKROOT }}/usr/lib/swift/windows"
            #   run: |
            #       swift.exe test --sdk C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk -Xswiftc -sdk -Xswiftc C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk -Xswiftc -resource-dir -Xswiftc C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk/usr/lib/swift -Xswiftc -I -Xswiftc C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk/usr/lib/swift -Xswiftc -L -Xswiftc C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk/usr/lib/swift/windows

    TestBuildingOnMacOS-11_0-ARM64:
        runs-on: "macos-11"
        steps:
            - uses: "actions/checkout@v2"
            - name: "Run tests"
              run: "swift build --arch arm64"
